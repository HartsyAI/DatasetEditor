@using HartsysDatasetEditor.Contracts.Datasets
@using HartsysDatasetEditor.Core.Utilities
@using System.Net.Http.Json
@using System.Text.Json
@inject DatasetState DatasetState
@inject NavigationManager Navigation
@inject HttpClient HttpClient

<MudMenu Icon="@Icons.Material.Filled.Dataset" 
         Label="@GetCurrentDatasetName()"
         Color="Color.Inherit"
         Dense="true">
    
    @if (_recentDatasets.Any())
    {
        <MudText Typo="Typo.subtitle2" Class="px-4 py-2">Recent Datasets</MudText>
        @foreach (DatasetSummaryDto dataset in _recentDatasets)
        {
            <MudMenuItem OnClick="@(() => SwitchToDataset(dataset))"
                        Icon="@Icons.Material.Filled.Dataset">
                <div>
                    <MudText Typo="Typo.body2">@dataset.Name</MudText>
                    <MudText Typo="Typo.caption">@dataset.TotalItems items</MudText>
                </div>
            </MudMenuItem>
        }
        <MudDivider />
    }
    
    <MudMenuItem OnClick="BrowseAll"
                Icon="@Icons.Material.Filled.FolderOpen">
        Browse All Datasets
    </MudMenuItem>
    
    <MudMenuItem OnClick="UploadNew"
                Icon="@Icons.Material.Filled.CloudUpload">
        Upload New Dataset
    </MudMenuItem>
</MudMenu>

@code {
    private List<DatasetSummaryDto> _recentDatasets = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRecentDatasetsAsync();
    }

    private async Task LoadRecentDatasetsAsync()
    {
        try
        {
            // Load recent datasets (first 5)
            HttpResponseMessage response = await HttpClient.GetAsync("/api/datasets?page=0&pageSize=5");
            
            if (response.IsSuccessStatusCode)
            {
                // Check if response is JSON
                string? contentType = response.Content.Headers.ContentType?.MediaType;
                if (contentType != null && !contentType.Contains("json", StringComparison.OrdinalIgnoreCase))
                {
                    Logs.Warning($"API returned non-JSON content: {contentType}");
                    return;
                }
                
                string json = await response.Content.ReadAsStringAsync();
                
                // Handle empty or invalid JSON
                if (string.IsNullOrWhiteSpace(json) || json.StartsWith("<"))
                {
                    Logs.Warning("API returned empty or HTML response (likely no datasets exist yet)");
                    _recentDatasets = new List<DatasetSummaryDto>();
                    return;
                }
                
                using JsonDocument doc = JsonDocument.Parse(json);
                
                if (doc.RootElement.TryGetProperty("datasets", out JsonElement datasetsElement))
                {
                    _recentDatasets = JsonSerializer.Deserialize<List<DatasetSummaryDto>>(
                        datasetsElement.GetRawText(),
                        new JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new();
                }
                else
                {
                    _recentDatasets = new List<DatasetSummaryDto>();
                }
            }
            else
            {
                Logs.Warning($"Failed to load recent datasets: {response.StatusCode}");
                _recentDatasets = new List<DatasetSummaryDto>();
            }
        }
        catch (Exception ex)
        {
            Logs.Error("Failed to load recent datasets", ex);
            _recentDatasets = new List<DatasetSummaryDto>();
        }
    }

    private string GetCurrentDatasetName()
    {
        return DatasetState.CurrentDataset?.Name ?? "Select Dataset";
    }

    private void SwitchToDataset(DatasetSummaryDto dataset)
    {
        Navigation.NavigateTo($"/dataset-viewer?id={dataset.Id}");
    }

    private void BrowseAll()
    {
        Navigation.NavigateTo("/my-datasets");
    }

    private void UploadNew()
    {
        Navigation.NavigateTo("/upload");
    }
}
