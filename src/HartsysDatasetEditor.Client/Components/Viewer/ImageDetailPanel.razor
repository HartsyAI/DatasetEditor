@using HartsysDatasetEditor.Core.Models
@using HartsysDatasetEditor.Client.Services.StateManagement

@if (Item != null)
{
    <MudPaper Class="pa-4 h-100 overflow-y-auto" Elevation="1">
        <MudStack Spacing="3">
            @* Image Preview *@
            <div class="detail-image-container">
                <img src="@Item.ImageUrl" alt="@Item.Title" class="detail-image" />
            </div>
            
            @* Title - Editable *@
            <MudStack Spacing="1">
                @if (_isEditingTitle)
                {
                    <MudTextField @bind-Value="_editTitle"
                                 Label="Title"
                                 Variant="Variant.Outlined"
                                 Immediate="true"
                                 AutoFocus="true"
                                 OnKeyUp="HandleTitleKeyUp"
                                 OnBlur="SaveTitle" />
                }
                else
                {
                    <div class="d-flex align-center justify-space-between">
                        <MudText Typo="Typo.h6">@Item.Title</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                      Size="Size.Small" 
                                      OnClick="StartEditTitle" />
                    </div>
                }
            </MudStack>

            @* Description - Editable *@
            <MudStack Spacing="1">
                <MudText Typo="Typo.subtitle2">Description</MudText>
                @if (_isEditingDescription)
                {
                    <MudTextField @bind-Value="_editDescription"
                                 Lines="3"
                                 Variant="Variant.Outlined"
                                 Immediate="true"
                                 AutoFocus="true"
                                 OnBlur="SaveDescription" />
                }
                else
                {
                    <div class="d-flex align-start justify-space-between">
                        <MudText Typo="Typo.body2" Class="flex-grow-1">
                            @(string.IsNullOrEmpty(Item.Description) ? "No description" : Item.Description)
                        </MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                      Size="Size.Small" 
                                      OnClick="StartEditDescription" />
                    </div>
                }
            </MudStack>

            <MudDivider />

            @* Tags *@
            <MudStack Spacing="2">
                <div class="d-flex align-center justify-space-between">
                    <MudText Typo="Typo.subtitle2">Tags</MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                  Size="Size.Small" 
                                  Color="Color.Primary"
                                  OnClick="ShowAddTagDialog" />
                </div>
                @if (Item.Tags.Any())
                {
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (string tag in Item.Tags)
                        {
                            <MudChip T="string" 
                                    Text="@tag" 
                                    OnClose="() => RemoveTag(tag)"
                                    CloseIcon="@Icons.Material.Filled.Cancel">
                                @tag
                            </MudChip>
                        }
                    </div>
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">No tags</MudText>
                }
            </MudStack>

            <MudDivider />

            @* Metadata *@
            <MudStack Spacing="2">
                <MudText Typo="Typo.subtitle2">Metadata</MudText>
                <MudSimpleTable Dense="true" Hover="true">
                    <tbody>
                        <tr>
                            <td><strong>Dimensions</strong></td>
                            <td>@Item.GetFormattedDimensions()</td>
                        </tr>
                        <tr>
                            <td><strong>Aspect Ratio</strong></td>
                            <td>@Item.GetAspectRatioString()</td>
                        </tr>
                        <tr>
                            <td><strong>File Size</strong></td>
                            <td>@Item.GetFormattedFileSize()</td>
                        </tr>
                        <tr>
                            <td><strong>Format</strong></td>
                            <td>@Item.Format</td>
                        </tr>
                        @if (!string.IsNullOrEmpty(Item.Photographer))
                        {
                            <tr>
                                <td><strong>Photographer</strong></td>
                                <td>@Item.Photographer</td>
                            </tr>
                        }
                        <tr>
                            <td><strong>Created</strong></td>
                            <td>@Item.CreatedAt.ToString("g")</td>
                        </tr>
                        <tr>
                            <td><strong>Updated</strong></td>
                            <td>@Item.UpdatedAt.ToString("g")</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudStack>

            @* Engagement Stats *@
            @if (Item.Views > 0 || Item.Likes > 0 || Item.Downloads > 0)
            {
                <MudDivider />
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">Engagement</MudText>
                    <div class="d-flex gap-4">
                        @if (Item.Views > 0)
                        {
                            <div class="d-flex align-center gap-1">
                                <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" />
                                <MudText Typo="Typo.body2">@Item.Views.ToString("N0")</MudText>
                            </div>
                        }
                        @if (Item.Likes > 0)
                        {
                            <div class="d-flex align-center gap-1">
                                <MudIcon Icon="@Icons.Material.Filled.Favorite" Size="Size.Small" />
                                <MudText Typo="Typo.body2">@Item.Likes.ToString("N0")</MudText>
                            </div>
                        }
                        @if (Item.Downloads > 0)
                        {
                            <div class="d-flex align-center gap-1">
                                <MudIcon Icon="@Icons.Material.Filled.Download" Size="Size.Small" />
                                <MudText Typo="Typo.body2">@Item.Downloads.ToString("N0")</MudText>
                            </div>
                        }
                    </div>
                </MudStack>
            }

            @* Color Palette *@
            @if (Item.DominantColors.Any())
            {
                <MudDivider />
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">Color Palette</MudText>
                    <div class="d-flex gap-2">
                        @foreach (string color in Item.DominantColors.Take(8))
                        {
                            <div class="color-swatch" style="background-color: @color;" title="@color"></div>
                        }
                    </div>
                </MudStack>
            }

            <MudDivider />

            @* Actions *@
            <MudStack Spacing="2">
                <MudText Typo="Typo.subtitle2">Actions</MudText>
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Download"
                          OnClick="HandleDownload"
                          FullWidth="true">
                    Download
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Secondary"
                          StartIcon="@Icons.Material.Filled.Share"
                          OnClick="HandleShare"
                          FullWidth="true">
                    Share
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Error"
                          StartIcon="@Icons.Material.Filled.Delete"
                          OnClick="HandleDelete"
                          FullWidth="true">
                    Delete
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>
}
else
{
    <MudPaper Class="pa-4 h-100" Elevation="1">
        <MudText Typo="Typo.body1" Align="Align.Center" Class="mud-text-secondary">
            Select an image to view details
        </MudText>
    </MudPaper>
}

<style>
    .detail-image-container {
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        background: var(--mud-palette-background-grey);
    }

    .detail-image {
        width: 100%;
        height: auto;
        display: block;
    }

    .color-swatch {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
</style>
