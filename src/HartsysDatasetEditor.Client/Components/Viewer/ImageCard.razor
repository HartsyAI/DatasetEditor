@using HartsysDatasetEditor.Core.Models
@using HartsysDatasetEditor.Core.Utilities

<div class="image-card @(_isHovered ? "hovered" : "")" 
     @onmouseenter="HandleMouseEnter"
     @onmouseleave="HandleMouseLeave"
     @onclick="HandleClick">
    
    @* Selection checkbox (always visible in top-right) *@
    <div class="selection-checkbox" @onclick:stopPropagation="true">
        <MudCheckBox T="bool" 
                     Checked="@IsSelected" 
                     CheckedChanged="@HandleToggleSelect"
                     Color="Color.Primary"
                     Size="Size.Small" />
    </div>
    
    @* Favorite star (top-left) *@
    <div class="favorite-icon" @onclick:stopPropagation="true" @onclick="HandleToggleFavorite">
        <MudIcon Icon="@(Item.IsFavorite ? Icons.Material.Filled.Star : Icons.Material.Outlined.StarBorder)" 
                 Color="@(Item.IsFavorite ? Color.Warning : Color.Default)"
                 Size="Size.Small" />
    </div>
    
    @* Image *@
    <div class="image-container">
        @if (_imageLoaded && !_imageError)
        {
            <img src="@_imageUrl" 
                 alt="@Item.Title"
                 loading="lazy"
                 @onerror="HandleImageError"
                 class="image" />
        }
        else if (_imageError)
        {
            <div class="error-placeholder">
                <MudIcon Icon="@Icons.Material.Filled.BrokenImage" Size="Size.Large" />
                <MudText Typo="Typo.caption">Failed to load</MudText>
            </div>
        }
        else
        {
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100%" />
        }
    </div>
    
    @* Tier 1: Basic overlay (always visible) *@
    <div class="basic-overlay">
        <div class="title-row">
            <MudText Typo="Typo.body2" Class="title-text">@GetDisplayTitle()</MudText>
        </div>
        @if (!string.IsNullOrEmpty(Item.Photographer))
        {
            <MudText Typo="Typo.caption" Class="photographer-text">@Item.Photographer</MudText>
        }
        <div class="stats-badge">
            <MudChip Size="Size.Small" Color="Color.Default">@Item.GetAspectRatioString()</MudChip>
        </div>
    </div>
    
    @* Tier 2: Hover overlay (visible on hover) *@
    @if (_isHovered && ViewState.Settings.ShowMetadataOverlay)
    {
        <div class="hover-overlay">
            <MudText Typo="Typo.body2" Class="full-title">@Item.Title</MudText>
            
            @if (!string.IsNullOrEmpty(Item.Description))
            {
                <MudText Typo="Typo.caption" Class="description">
                    @GetTruncatedDescription()
                </MudText>
            }
            
            <div class="metadata-row">
                <MudIcon Icon="@Icons.Material.Outlined.AspectRatio" Size="Size.Small" />
                <MudText Typo="Typo.caption">@Item.GetFormattedDimensions()</MudText>
            </div>
            
            @if (Item.FileSizeBytes > 0)
            {
                <div class="metadata-row">
                    <MudIcon Icon="@Icons.Material.Outlined.Storage" Size="Size.Small" />
                    <MudText Typo="Typo.caption">@Item.GetFormattedFileSize()</MudText>
                </div>
            }
            
            @if (Item.Tags.Any())
            {
                <div class="tags-row">
                    @foreach (string tag in Item.Tags.Take(3))
                    {
                        <MudChip Size="Size.Small" Color="Color.Default">@tag</MudChip>
                    }
                    @if (Item.Tags.Count > 3)
                    {
                        <MudChip Size="Size.Small" Color="Color.Default">+@(Item.Tags.Count - 3)</MudChip>
                    }
                </div>
            }
            
            @if (Item.DominantColors.Any())
            {
                <div class="color-chips">
                    @foreach (string color in Item.DominantColors.Take(5))
                    {
                        <div class="color-chip" style="background-color: @color;"></div>
                    }
                </div>
            }
            
            @if (!string.IsNullOrEmpty(Item.GetEngagementSummary()))
            {
                <MudText Typo="Typo.caption" Class="engagement-stats">
                    @Item.GetEngagementSummary()
                </MudText>
            }
            
            @* Quick action buttons *@
            <div class="quick-actions">
                <MudIconButton Icon="@Icons.Material.Outlined.Download" 
                              Size="Size.Small" 
                              Color="Color.Default"
                              OnClick="HandleDownload" />
                <MudIconButton Icon="@Icons.Material.Outlined.Edit" 
                              Size="Size.Small" 
                              Color="Color.Default"
                              OnClick="HandleEditClick" />
                <MudIconButton Icon="@Icons.Material.Outlined.MoreVert" 
                              Size="Size.Small" 
                              Color="Color.Default"
                              OnClick="HandleMenuClick" />
            </div>
        </div>
    }
</div>

<style>
    .image-card {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        background: var(--mud-palette-background);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        height: 100%;
    }
    
    .image-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .selection-checkbox {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 3;
        background: rgba(255,255,255,0.9);
        border-radius: 4px;
        padding: 2px;
    }
    
    .favorite-icon {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 3;
        background: rgba(255,255,255,0.9);
        border-radius: 50%;
        padding: 4px;
        cursor: pointer;
    }
    
    .image-container {
        width: 100%;
        aspect-ratio: 1 / 1;
        overflow: hidden;
    }
    
    .image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .error-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: var(--mud-palette-background-grey);
    }
    
    .basic-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 12px;
        background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        color: white;
        z-index: 1;
    }
    
    .title-text {
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .photographer-text {
        opacity: 0.9;
    }
    
    .stats-badge {
        margin-top: 4px;
    }
    
    .hover-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 16px;
        background: rgba(0,0,0,0.85);
        color: white;
        z-index: 2;
        display: flex;
        flex-direction: column;
        gap: 8px;
        animation: fadeIn 0.2s ease;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .full-title {
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .description {
        opacity: 0.9;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .metadata-row {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
    }
    
    .tags-row {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }
    
    .color-chips {
        display: flex;
        gap: 4px;
    }
    
    .color-chip {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 1px solid rgba(255,255,255,0.3);
    }
    
    .engagement-stats {
        margin-top: 4px;
        opacity: 0.8;
    }
    
    .quick-actions {
        display: flex;
        gap: 4px;
        margin-top: auto;
    }
</style>
