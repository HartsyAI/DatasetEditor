@using Blazored.LocalStorage
@using DatasetStudio.ClientApp.Services.StateManagement
@using Microsoft.AspNetCore.Components.Web

<MudStack Spacing="3">
    <MudText Typo="Typo.subtitle1">API keys</MudText>

    <MudText Typo="Typo.caption" Class="mud-text-secondary">
        API keys are stored locally in this browser only. They are never sent to Hartsy servers.
    </MudText>

    <MudPaper Class="pa-3" Elevation="0">
        <MudText Typo="Typo.subtitle2">Hugging Face</MudText>
        <MudTextField T="string" @@@bind-Value="_huggingFaceToken"
                      Label="Access token"
                      InputType="InputType.Password"
                      Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.Key"
                      OnBlur="OnHuggingFaceTokenChangedAsync" />
    </MudPaper>

    <MudPaper Class="pa-3 mt-2" Elevation="0">
        <MudText Typo="Typo.subtitle2">Hartsy</MudText>
        <MudTextField T="string" @@@bind-Value="_hartsyApiKey"
                      Label="API key"
                      InputType="InputType.Password"
                      Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.Key"
                      OnBlur="OnHartsyKeyChangedAsync" />
    </MudPaper>
</MudStack>

@code {
    [Inject] public ApiKeyState ApiKeyState { get; set; } = default!;
    [Inject] public ILocalStorageService LocalStorage { get; set; } = default!;

    private string? _huggingFaceToken;
    private string? _hartsyApiKey;

    protected override async Task OnInitializedAsync()
    {
        await ApiKeyState.LoadFromStorageAsync(LocalStorage);
        _huggingFaceToken = ApiKeyState.GetToken(ApiKeyState.ProviderHuggingFace);
        _hartsyApiKey = ApiKeyState.GetToken(ApiKeyState.ProviderHartsy);
    }

    private async Task OnHuggingFaceTokenChangedAsync(FocusEventArgs _)
    {
        ApiKeyState.SetToken(ApiKeyState.ProviderHuggingFace, _huggingFaceToken);
        await ApiKeyState.SaveToStorageAsync(LocalStorage);
    }

    private async Task OnHartsyKeyChangedAsync(FocusEventArgs _)
    {
        ApiKeyState.SetToken(ApiKeyState.ProviderHartsy, _hartsyApiKey);
        await ApiKeyState.SaveToStorageAsync(LocalStorage);
    }
}
