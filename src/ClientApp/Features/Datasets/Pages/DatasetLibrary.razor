@page "/my-datasets"
@using DatasetStudio.DTO.Datasets
@using MudBlazor

<PageTitle>My Datasets - DatasetStudio</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudText Typo="Typo.h4" Class="mb-4">My Datasets</MudText>

    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudStack Spacing="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <MudTextField T="string"
                             @@@bind-Value="@_searchQuery"
                             Label="Search datasets"
                             Variant="Variant.Outlined"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             Immediate="true"
                             OnKeyUp="HandleSearchKeyUp" />

                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.Add"
                          Href="/upload">
                    Upload New Dataset
                </MudButton>
            </MudStack>

            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudSelect T="IngestionStatusDto?" Label="Status" Value="@_statusFilter" ValueChanged="OnStatusFilterChanged" ValueExpression="@(() => _statusFilter)" Dense="true" Variant="Variant.Outlined" Class="mr-2" Style="min-width: 180px;">
                    <MudSelectItem T="IngestionStatusDto?" Value="@(null)">All statuses</MudSelectItem>
                    <MudSelectItem T="IngestionStatusDto?" Value="IngestionStatusDto.Pending">Pending</MudSelectItem>
                    <MudSelectItem T="IngestionStatusDto?" Value="IngestionStatusDto.Processing">Processing</MudSelectItem>
                    <MudSelectItem T="IngestionStatusDto?" Value="IngestionStatusDto.Completed">Completed</MudSelectItem>
                    <MudSelectItem T="IngestionStatusDto?" Value="IngestionStatusDto.Failed">Failed</MudSelectItem>
                </MudSelect>

                <MudSelect T="DatasetSourceType?" Label="Source" Value="@_sourceFilter" ValueChanged="OnSourceFilterChanged" ValueExpression="@(() => _sourceFilter)" Dense="true" Variant="Variant.Outlined" Class="mr-2" Style="min-width: 200px;">
                    <MudSelectItem T="DatasetSourceType?" Value="@(null)">All sources</MudSelectItem>
                    <MudSelectItem T="DatasetSourceType?" Value="DatasetSourceType.LocalUpload">Local upload</MudSelectItem>
                    <MudSelectItem T="DatasetSourceType?" Value="DatasetSourceType.HuggingFaceDownload">HuggingFace download</MudSelectItem>
                    <MudSelectItem T="DatasetSourceType?" Value="DatasetSourceType.HuggingFaceStreaming">HuggingFace streaming</MudSelectItem>
                    <MudSelectItem T="DatasetSourceType?" Value="DatasetSourceType.ExternalS3Streaming">External S3 streaming</MudSelectItem>
                </MudSelect>

                <MudSwitch T="bool" @@@bind-Value="_onlyReady" Color="Color.Primary" Class="ml-2" DisableRipple="true">
                    <MudText Typo="Typo.caption">Only ready datasets</MudText>
                </MudSwitch>
            </MudStack>
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    @if (_filteredDatasets.Any())
    {
        <MudGrid>
            @foreach (DatasetSummaryDto dataset in _filteredDatasets)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2" Class="dataset-card">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@dataset.Name</MudText>
                                <MudText Typo="Typo.caption">
                                    @dataset.TotalItems items â€¢ @(string.IsNullOrWhiteSpace(dataset.Modality) ? "Unknown" : dataset.Modality)
                                </MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(dataset.Status)" Variant="Variant.Filled">
                                    @dataset.Status
                                </MudChip>
                            </CardHeaderActions>
                        </MudCardHeader>

                        <MudCardContent>
                            @if (!string.IsNullOrEmpty(dataset.Description))
                            {
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    @GetTruncatedDescription(dataset.Description)
                                </MudText>
                            }

                            <MudStack Row="true" Spacing="1" Class="mb-1">
                                <MudChip T="string" Size="Size.Small" Color="Color.Default">
                                    @(string.IsNullOrWhiteSpace(dataset.Format) ? "Unknown format" : dataset.Format)
                                </MudChip>
                                <MudChip T="string" Size="Size.Small" Color="Color.Default">
                                    @(string.IsNullOrWhiteSpace(dataset.Modality) ? "Unknown modality" : dataset.Modality)
                                </MudChip>
                            </MudStack>

                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                @GetSourceLabel(dataset)
                            </MudText>
                        </MudCardContent>

                        <MudCardActions>
                            <MudButton Variant="Variant.Text"
                                      Color="Color.Primary"
                                      StartIcon="@Icons.Material.Filled.Visibility"
                                      OnClick="@(() => ViewDataset(dataset))">
                                Open
                            </MudButton>
                            <MudButton Variant="Variant.Text"
                                      Color="Color.Error"
                                      StartIcon="@Icons.Material.Filled.Delete"
                                      OnClick="@(() => DeleteDatasetAsync(dataset))">
                                Delete
                            </MudButton>
                            <MudSpacer />
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                Updated @FormatTimeAgo(dataset.UpdatedAt)
                            </MudText>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else if (!_isLoading)
    {
        <MudPaper Class="pa-8" Elevation="0">
            <MudStack AlignItems="AlignItems.Center" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.h6">No datasets yet</MudText>
                <MudText Typo="Typo.body2" Align="Align.Center">
                    Upload your first dataset to get started
                </MudText>
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.CloudUpload"
                          Href="/upload">
                    Upload Dataset
                </MudButton>
            </MudStack>
        </MudPaper>
    }
</MudContainer>

<style>
    .dataset-card {
        height: 100%;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s ease;
    }

    .dataset-card:hover {
        transform: translateY(-4px);
    }
</style>
