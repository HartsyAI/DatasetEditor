@using DatasetStudio.DTO.Datasets

<MudPaper Class="pa-4" Elevation="2">
    <MudStack Spacing="3">
        <MudText Typo="Typo.h6">Dataset Options</MudText>

        @if (DiscoveryResponse == null)
        {
            <MudProgressCircular Indeterminate="true" Size="Size.Medium" />
            <MudText>Discovering dataset options...</MudText>
        }
        else if (!DiscoveryResponse.IsAccessible)
        {
            <MudAlert Severity="Severity.Error">
                <strong>Dataset Not Accessible</strong>
                <div>@DiscoveryResponse.ErrorMessage</div>
            </MudAlert>
        }
        else
        {
            @* Dataset Metadata *@
            @if (DiscoveryResponse.Metadata != null)
            {
                <MudPaper Class="pa-3" Elevation="1">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.subtitle1"><strong>@DiscoveryResponse.Metadata.Id</strong></MudText>
                        @if (!string.IsNullOrWhiteSpace(DiscoveryResponse.Metadata.Author))
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">by @DiscoveryResponse.Metadata.Author</MudText>
                        }
                        <MudText Typo="Typo.caption">@DiscoveryResponse.Metadata.FileCount files</MudText>
                    </MudStack>
                </MudPaper>
            }

            @* Streaming Options *@
            @if (IsStreamingMode && DiscoveryResponse.StreamingOptions != null)
            {
                @if (DiscoveryResponse.StreamingOptions.IsSupported)
                {
                    <MudPaper Class="pa-3" Elevation="1">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle1">
                                <MudIcon Icon="@Icons.Material.Filled.Stream" Size="Size.Small" Class="mr-2" />
                                Streaming Options
                            </MudText>

                            @if (DiscoveryResponse.StreamingOptions.AvailableOptions.Count == 1)
                            {
                                <MudAlert Severity="Severity.Success" Dense="true">
                                    <strong>Single configuration found:</strong>
                                    <div>@DiscoveryResponse.StreamingOptions.RecommendedOption?.DisplayLabel</div>
                                </MudAlert>
                            }
                            else if (DiscoveryResponse.StreamingOptions.AvailableOptions.Count > 1)
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Multiple configurations detected. Select one to stream:
                                </MudText>

                                <MudRadioGroup T="HuggingFaceConfigOption" @bind-Value="_selectedStreamingOption">
                                    @foreach (var option in DiscoveryResponse.StreamingOptions.AvailableOptions)
                                    {
                                        <MudRadio Value="@option" Color="Color.Primary">
                                            <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                                <div>
                                                    <strong>@option.DisplayLabel</strong>
                                                    @if (option.IsRecommended)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">Recommended</MudChip>
                                                    }
                                                </div>
                                            </div>
                                        </MudRadio>
                                    }
                                </MudRadioGroup>
                            }
                        </MudStack>
                    </MudPaper>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning">
                        <strong>Streaming Not Supported</strong>
                        <div>@DiscoveryResponse.StreamingOptions.UnsupportedReason</div>
                        <div class="mt-2">Try download mode instead.</div>
                    </MudAlert>
                }
            }

            @* Download Options *@
            @if (!IsStreamingMode && DiscoveryResponse.DownloadOptions != null)
            {
                @if (DiscoveryResponse.DownloadOptions.IsAvailable)
                {
                    <MudPaper Class="pa-3" Elevation="1">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle1">
                                <MudIcon Icon="@Icons.Material.Filled.Download" Size="Size.Small" Class="mr-2" />
                                Download Options
                            </MudText>

                            @if (DiscoveryResponse.DownloadOptions.HasImageFilesOnly)
                            {
                                <MudAlert Severity="Severity.Info" Dense="true">
                                    <strong>Image-only dataset</strong>
                                    <div>@DiscoveryResponse.DownloadOptions.ImageFileCount images will be imported directly.</div>
                                </MudAlert>
                            }
                            else if (DiscoveryResponse.DownloadOptions.AvailableFiles.Count == 1)
                            {
                                <MudAlert Severity="Severity.Success" Dense="true">
                                    <strong>Data file found:</strong>
                                    <div>@DiscoveryResponse.DownloadOptions.PrimaryFile?.Path (@FormatFileSize(DiscoveryResponse.DownloadOptions.PrimaryFile?.Size ?? 0))</div>
                                </MudAlert>
                            }
                            else if (DiscoveryResponse.DownloadOptions.AvailableFiles.Count > 1)
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Multiple data files detected. Select one to download:
                                </MudText>

                                <MudRadioGroup T="HuggingFaceDataFileOption" @bind-Value="_selectedDownloadFile">
                                    @foreach (var file in DiscoveryResponse.DownloadOptions.AvailableFiles)
                                    {
                                        <MudRadio Value="@file" Color="Color.Primary">
                                            <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                                <div>
                                                    <strong>@file.Path</strong>
                                                    @if (file.IsPrimary)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">Recommended</MudChip>
                                                    }
                                                </div>
                                                <MudText Typo="Typo.caption">@FormatFileSize(file.Size)</MudText>
                                            </div>
                                        </MudRadio>
                                    }
                                </MudRadioGroup>
                            }
                        </MudStack>
                    </MudPaper>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning">
                        <strong>No downloadable files found</strong>
                        <div>This dataset doesn't contain supported data files (CSV, JSON, Parquet).</div>
                    </MudAlert>
                }
            }

            @* Action Buttons *@
            <MudStack Row="true" Spacing="2" Class="mt-4">
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.Check"
                          OnClick="@OnConfirmClicked"
                          Disabled="@(!CanConfirm)"
                          FullWidth="true">
                    Confirm and Import
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                          Color="Color.Default"
                          OnClick="@OnCancelClicked">
                    Cancel
                </MudButton>
            </MudStack>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public HuggingFaceDiscoveryResponse? DiscoveryResponse { get; set; }

    [Parameter]
    public bool IsStreamingMode { get; set; }

    [Parameter]
    public EventCallback<(string? Config, string? Split, string? DataFilePath)> OnConfirm { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private HuggingFaceConfigOption? _selectedStreamingOption;
    private HuggingFaceDataFileOption? _selectedDownloadFile;

    protected override void OnParametersSet()
    {
        // Auto-select recommended options
        if (DiscoveryResponse != null)
        {
            if (IsStreamingMode && DiscoveryResponse.StreamingOptions?.RecommendedOption != null)
            {
                _selectedStreamingOption = DiscoveryResponse.StreamingOptions.RecommendedOption;
            }

            if (!IsStreamingMode && DiscoveryResponse.DownloadOptions?.PrimaryFile != null)
            {
                _selectedDownloadFile = DiscoveryResponse.DownloadOptions.PrimaryFile;
            }
        }
    }

    private bool CanConfirm
    {
        get
        {
            if (DiscoveryResponse == null || !DiscoveryResponse.IsAccessible)
                return false;

            if (IsStreamingMode)
            {
                return DiscoveryResponse.StreamingOptions?.IsSupported == true &&
                       _selectedStreamingOption != null;
            }
            else
            {
                return DiscoveryResponse.DownloadOptions?.IsAvailable == true &&
                       (DiscoveryResponse.DownloadOptions.HasImageFilesOnly ||
                        _selectedDownloadFile != null);
            }
        }
    }

    private async Task OnConfirmClicked()
    {
        if (IsStreamingMode && _selectedStreamingOption != null)
        {
            await OnConfirm.InvokeAsync((_selectedStreamingOption.Config, _selectedStreamingOption.Split, null));
        }
        else if (!IsStreamingMode && _selectedDownloadFile != null)
        {
            await OnConfirm.InvokeAsync((null, null, _selectedDownloadFile.Path));
        }
        else if (!IsStreamingMode && DiscoveryResponse?.DownloadOptions?.HasImageFilesOnly == true)
        {
            // Image-only dataset - no file selection needed
            await OnConfirm.InvokeAsync((null, null, null));
        }
    }

    private async Task OnCancelClicked()
    {
        await OnCancel.InvokeAsync();
    }

    private static string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;

        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }

        return $"{len:0.##} {sizes[order]}";
    }
}
