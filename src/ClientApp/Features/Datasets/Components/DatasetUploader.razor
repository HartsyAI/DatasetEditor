@using DatasetStudio.Core.Utilities
@using Microsoft.AspNetCore.Components.Forms

<MudPaper Class="pa-4" Elevation="2">
    <MudStack Spacing="3">
        <MudText Typo="Typo.h6">Upload Dataset</MudText>

        @* Tab Selection *@
        <MudTabs Elevation="0" @bind-ActivePanelIndex="_activeTabIndex" ApplyEffectsToContainer="true">
            <MudTabPanel Text="Upload Files" Icon="@Icons.Material.Filled.CloudUpload">
                @* File Upload Content *@
                <MudStack Spacing="3" Class="mt-4">
                    @* Drag-Drop Upload Zone *@
        <div class="upload-dropzone @(_isDragging ? "dragging" : "")"
             @ondragenter="@HandleDragEnter"
             @ondragleave="@HandleDragLeave"
             @ondragover:preventDefault="true"
             @ondrop="@HandleDrop"
             @ondrop:preventDefault="true">
            
            <MudStack AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Large" Color="Color.Primary" />
                <MudText Typo="Typo.h6">Drag & Drop Files or ZIP</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">or</MudText>
                
                <InputFile @key="_fileInputKey"
                          id="fileInput" 
                          OnChange="@HandleFilesSelected" 
                          accept=".tsv,.tsv000,.csv,.csv000,.txt,.zip"
                          multiple
                          style="display: none;" />
                
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Folder"
                          OnClick="@OpenFilePickerAsync">
                    Select Files or ZIP
                </MudButton>
                
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    Supported: TSV, CSV, ZIP with primary + enrichment files
                </MudText>
            </MudStack>
        </div>
        
        @* Upload Progress *@
        @if (_isUploading)
        {
            <MudPaper Class="pa-4" Elevation="3">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6" Align="Align.Center">Uploading Dataset</MudText>
                    
                    <MudProgressLinear Color="Color.Primary" 
                                      Value="@_uploadProgress" 
                                      Size="Size.Large"
                                      Striped="true"
                                      Class="my-2" />
                    
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body2">
                            @_uploadStatus
                        </MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            @_uploadProgress%
                        </MudText>
                    </MudStack>
                    
                    @if (!string.IsNullOrEmpty(_estimatedTimeRemaining))
                    {
                        <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Secondary">
                            @_estimatedTimeRemaining
                        </MudText>
                    }
                </MudStack>
            </MudPaper>
        }
        
        @* Error Display *@
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Dense="true">
                @_errorMessage
            </MudAlert>
        }
        
        @* Analysis Progress (for ZIP detection, file reading) *@
        @if (!_isUploading && !string.IsNullOrEmpty(_uploadStatus) && _uploadProgress > 0)
        {
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.body1">
                        <MudIcon Icon="@Icons.Material.Filled.Analytics" Size="Size.Small" Class="mr-2" />
                        @_uploadStatus
                    </MudText>
                    <MudProgressLinear Color="Color.Info" 
                                      Value="@_uploadProgress" 
                                      Size="Size.Medium"
                                      Striped="true" />
                </MudStack>
            </MudPaper>
        }
        
        @* ZIP Detection Alert *@
        @if (!_isUploading && _selectedFiles.Any(f => f.Name.EndsWith(".zip", StringComparison.OrdinalIgnoreCase)))
        {
            <MudAlert Severity="Severity.Info" Class="my-2">
                <strong>ZIP Archive Detected</strong>
                <div>Click the <strong>Upload Dataset</strong> button below to extract and process the ZIP file.</div>
                <div class="mt-2">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" />
                    This may take a few minutes for large files.
                </div>
            </MudAlert>
        }
        
        @* Selected Files Display *@
        @if (_selectedFiles.Any())
        {
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Selected Files</MudText>
                <MudList T="string">
                    @foreach (IBrowserFile file in _selectedFiles)
                    {
                        <MudListItem T="string">
                            <div class="d-flex align-center justify-space-between">
                                <div>
                                    <MudText Typo="Typo.body1">@file.Name</MudText>
                                    <MudText Typo="Typo.caption">@FormatFileSize(file.Size)</MudText>
                                </div>
                                <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                    @GetFileTypeLabel(file.Name)
                                </MudChip>
                            </div>
                        </MudListItem>
                    }
                </MudList>
                
                @if (_detectedCollection != null)
                {
                    <MudDivider Class="my-4" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Auto-Detection Results</MudText>
                    <MudAlert Severity="Severity.Success" Class="mb-2">
                        <strong>Primary File:</strong> @_detectedCollection.PrimaryFileName
                    </MudAlert>
                    
                    @if (_detectedCollection.EnrichmentFiles.Any())
                    {
                        <MudAlert Severity="Severity.Info">
                            <strong>Enrichment Files:</strong>
                            <ul class="my-2">
                                @foreach (var enrichment in _detectedCollection.EnrichmentFiles)
                                {
                                    <li>@enrichment.FileName (@enrichment.Info.EnrichmentType - @enrichment.Info.RecordCount records)</li>
                                }
                            </ul>
                        </MudAlert>
                    }
                    
                    @* Upload Actions *@
                    <MudStack Row="true" Spacing="2" Class="mt-4">
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  StartIcon="@Icons.Material.Filled.CloudUpload"
                                  OnClick="@UploadDetectedCollectionAsync"
                                  Disabled="@_isUploading"
                                  FullWidth="true">
                            @(_isUploading ? "Uploading..." : "Upload Dataset")
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                  Color="Color.Default"
                                  OnClick="@ClearSelection"
                                  Disabled="@_isUploading">
                            Clear
                        </MudButton>
                    </MudStack>
                }
            </MudPaper>
        }
                </MudStack>
            </MudTabPanel>

            <MudTabPanel Text="Import from HuggingFace" Icon="@Icons.Material.Filled.Cloud">
                @* HuggingFace Import Content *@
                <MudStack Spacing="3" Class="mt-4">
                    <MudAlert Severity="Severity.Info" Dense="true">
                        Import datasets directly from HuggingFace Hub. Supports CSV, TSV, JSON, and Parquet formats.
                    </MudAlert>

                    <MudTextField @bind-Value="_hfRepository"
                                 Label="Repository"
                                 Placeholder="username/dataset-name"
                                 HelperText="Enter HuggingFace dataset repository (e.g., 'imdb', 'squad', 'username/my-dataset')"
                                 Variant="Variant.Outlined"
                                 Immediate="true"
                                 Required="true" />

                    <MudTextField @bind-Value="_hfDatasetName"
                                 Label="Dataset Name (Optional)"
                                 Placeholder="My Dataset"
                                 HelperText="Override the default dataset name"
                                 Variant="Variant.Outlined" />

                    <MudTextField @bind-Value="_hfDescription"
                                 Label="Description (Optional)"
                                 Placeholder="Dataset description"
                                 Lines="3"
                                 Variant="Variant.Outlined" />

                    <MudTextField @bind-Value="_hfRevision"
                                 Label="Revision (Optional)"
                                 Placeholder="main"
                                 HelperText="Branch, tag, or commit (defaults to 'main')"
                                 Variant="Variant.Outlined" />

                    <MudTextField @bind-Value="_hfAccessToken"
                                 Label="Access Token (Optional)"
                                 Placeholder="hf_..."
                                 HelperText="Required for private datasets"
                                 Variant="Variant.Outlined"
                                 InputType="InputType.Password" />

                    <MudSwitch @bind-Value="_hfIsStreaming"
                              Label="Streaming Mode"
                              Color="Color.Primary">
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">
                            Streaming mode stores only a reference without downloading the full dataset
                        </MudText>
                    </MudSwitch>

                    @if (_hfShowOptions && _hfDiscoveryResponse != null)
                    {
                        <HuggingFaceDatasetOptions DiscoveryResponse="@_hfDiscoveryResponse"
                                                  IsStreamingMode="@_hfIsStreaming"
                                                  OnConfirm="@(async (tuple) => await ConfirmHuggingFaceOptions(tuple.Item1, tuple.Item2, tuple.Item3))"
                                                  OnCancel="@CancelHuggingFaceOptions" />
                    }
                    else if (!string.IsNullOrWhiteSpace(_hfRepository) && !_hfShowOptions)
                    {
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  StartIcon="@Icons.Material.Filled.Search"
                                  OnClick="@DiscoverHuggingFaceDatasetAsync"
                                  Disabled="@(_isUploading || _hfDiscovering)"
                                  FullWidth="true">
                            @(_hfDiscovering ? "Discovering Options..." : "Discover Dataset")
                        </MudButton>
                    }

                    @* HuggingFace Import Progress *@
                    @if (_isUploading && _activeTabIndex == 1)
                    {
                        <MudPaper Class="pa-4" Elevation="3">
                            <MudStack Spacing="3">
                                <MudText Typo="Typo.h6" Align="Align.Center">Importing from HuggingFace</MudText>

                                <MudProgressLinear Color="Color.Primary"
                                                  Indeterminate="true"
                                                  Size="Size.Large"
                                                  Striped="true"
                                                  Class="my-2" />

                                <MudText Typo="Typo.body2" Align="Align.Center">
                                    @_uploadStatus
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>
            </MudTabPanel>
        </MudTabs>
    </MudStack>
</MudPaper>

@code {
    // TODO: Move to separate .razor.cs file following component pattern
}

<style>
    .upload-dropzone {
        border: 2px dashed var(--mud-palette-primary);
        border-radius: 8px;
        padding: 48px 24px;
        text-align: center;
        transition: all 0.3s ease;
        background: var(--mud-palette-background-grey);
        cursor: pointer;
    }

    .upload-dropzone.dragging {
        border-color: var(--mud-palette-success);
        background: var(--mud-palette-success-lighten);
        transform: scale(1.02);
    }

    .upload-dropzone:hover {
        background: var(--mud-palette-action-default-hover);
    }
</style>
