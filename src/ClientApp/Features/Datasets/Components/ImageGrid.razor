@using DatasetStudio.Core.DomainModels
@using DatasetStudio.Core.Abstractions
@using DatasetStudio.Core.Utilities
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="image-grid-container" @ref="_scrollContainer">
    <div id="@_topSentinelId" class="top-sentinel"></div>
    <div class="image-grid columns-@_gridColumns">
        @foreach (IDatasetItem item in _visibleItems)
        {
            <ImageCard Item="@((ImageItem)item)" 
                      IsSelected="@IsItemSelected(item)"
                      OnClick="@(() => HandleItemClick(item))"
                      OnToggleSelect="@(() => HandleToggleSelection(item))"
                      OnEdit="@(() => HandleItemClick(item))" />
        }
    </div>
    
    @* Sentinel element for IntersectionObserver - triggers loading more items *@
    <div id="@_sentinelId" class="loading-sentinel">
        @if (_hasMore)
        {
            <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
            <MudText Typo="Typo.body2" Class="mud-text-secondary ml-3">
                @_isLoadingMore ? "Loading more images..." : "Scroll to load more"
            </MudText>
        }
        else
        {
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
            <MudText Typo="Typo.body2" Class="mud-text-secondary ml-2">
                All @_totalItemCount images loaded
            </MudText>
        }
    </div>
    
    @* Show when all items loaded *@
    
    
    @* Empty state *@
    @if (_visibleItems.Count == 0 && !_isLoadingMore)
    {
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="pa-8">
            <MudIcon Icon="@Icons.Material.Filled.ImageNotSupported" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.h6" Class="mud-text-secondary">No images to display</MudText>
            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                Try adjusting your filters or upload a dataset
            </MudText>
        </MudStack>
    }
</div>

<style>
    /* Container with scroll */
    .image-grid-container {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    /* Grid layout with dynamic columns */
    .image-grid {
        display: grid;
        gap: 16px;
        padding: 16px;
        width: 100%;
    }

    .image-grid.columns-1 { grid-template-columns: repeat(1, 1fr); }
    .image-grid.columns-2 { grid-template-columns: repeat(2, 1fr); }
    .image-grid.columns-3 { grid-template-columns: repeat(3, 1fr); }
    .image-grid.columns-4 { grid-template-columns: repeat(4, 1fr); }
    .image-grid.columns-5 { grid-template-columns: repeat(5, 1fr); }
    .image-grid.columns-6 { grid-template-columns: repeat(6, 1fr); }
    .image-grid.columns-7 { grid-template-columns: repeat(7, 1fr); }
    .image-grid.columns-8 { grid-template-columns: repeat(8, 1fr); }

    .top-sentinel {
        width: 100%;
        height: 1px;
    }

    /* Loading sentinel */
    .loading-sentinel {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px;
        width: 100%;
    }

    /* End of results */
    .end-of-results {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px;
        width: 100%;
    }

    /* Responsive breakpoints */
    @@media (max-width: 960px) {
        .image-grid.columns-6,
        .image-grid.columns-7,
        .image-grid.columns-8 { 
            grid-template-columns: repeat(4, 1fr); 
        }
    }

    @@media (max-width: 600px) {
        .image-grid { 
            grid-template-columns: repeat(2, 1fr) !important; 
        }
    }
</style>
